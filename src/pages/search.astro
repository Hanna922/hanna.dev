---
import { SITE } from "@config";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import SearchBar from "@components/Search";
import getPublishedPosts from "@utils/getPublishedPosts";
import { getLocalizedPostGroups } from "@utils/localizedPostGroups";
import { getLocaleFromValue, type LocaleCode } from "@utils/locale";

// Retrieve all published articles
const posts = await getPublishedPosts();
const locale = getLocaleFromValue(Astro.url.searchParams.get("lang")) ?? "ko";
const postGroups = getLocalizedPostGroups(posts);

// List of items to search in
const searchList = postGroups.flatMap(({ baseId, posts }) =>
  posts.map(({ data, slug, id }) => ({
    title: data.title,
    description: data.description,
    data,
    slug,
    baseId,
    locale: (id.replace(/\\/g, "/").endsWith(".en.md")
      ? "en"
      : "ko") as LocaleCode,
    entryId: id,
  }))
);

const pageTitle = `Search | ${SITE.title}`;
const pageDesc = "Search any article";
---

<Layout title={pageTitle} description={pageDesc}>
  <Header activeNav="search" />
  <Main
    pageTitle="Search"
    pageTitleI18n="search.title"
    pageDesc="Search any article ..."
    pageDescI18n="search.description"
  >
    <SearchBar client:load searchList={searchList} initialLocale={locale} />
  </Main>
  <Footer />
</Layout>
