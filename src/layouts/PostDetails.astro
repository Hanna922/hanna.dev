---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Tag from "@components/Tag.astro";
import Datetime from "@components/Datetime";
import { slugifyStr } from "@utils/slugify";
import ShareLinks from "@components/ShareLinks.astro";
import { SITE } from "@config";
import PostComments from "@components/PostComments.astro";
import PageViews from "@components/PageViews.astro";
import type { CollectionEntry } from "astro:content";

export interface Props {
  post: CollectionEntry<"blog">;
  locale?: "ko" | "en";
  koreanPost?: CollectionEntry<"blog"> | null;
  englishPost?: CollectionEntry<"blog"> | null;
}

const {
  post,
  locale = "ko",
  koreanPost = null,
  englishPost = null,
} = Astro.props;

const {
  title,
  author,
  description,
  ogImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
} = post.data;

const renderKoreanPost = koreanPost ?? (englishPost ? null : post);
const renderEnglishPost = englishPost ?? (koreanPost ? null : post);
const koreanRender = renderKoreanPost ? await renderKoreanPost.render() : null;
const englishRender = renderEnglishPost
  ? await renderEnglishPost.render()
  : null;
const KoreanContent = koreanRender?.Content;
const EnglishContent = englishRender?.Content;
const koreanData = renderKoreanPost?.data;
const englishData = renderEnglishPost?.data;

const ogImageUrl = typeof ogImage === "string" ? ogImage : ogImage?.src;
const ogUrl = new URL(
  ogImageUrl ?? `/posts/${slugifyStr(title)}.png`,
  Astro.url.origin
).href;

const url = new URL(Astro.url.pathname, Astro.url.origin).href;

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  author,
  description,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage: ogUrl,
  scrollSmooth: true,
};
---

<Layout {...layoutProps}>
  <Header />

  <!-- <div class="progress-container fixed top-0 z-10 h-1 w-full bg-skin-fill">
    <div class="progress-bar h-1 w-0 bg-skin-accent" id="myBar"></div>
  </div> -->

  <div class="mx-auto flex w-full max-w-3xl justify-start px-2">
    <button
      class="focus-outline mb-2 mt-8 flex hover:opacity-75"
      onclick="(() => (history.length === 1) ? window.location = '/' : history.back())()"
    >
      <svg xmlns="http://www.w3.org/2000/svg"
        ><path
          d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"
        ></path>
      </svg><span data-i18n="post.goBack">Go back</span>
    </button>
  </div>
  <main id="main-content">
    <PageViews url={url} />
    {
      KoreanContent && koreanData && (
        <section
          data-post-detail-locale="ko"
          data-post-title={`${koreanData.title} | ${SITE.title}`}
          hidden={locale === "en" && Boolean(EnglishContent)}
        >
          <h1 class="post-title">{koreanData.title}</h1>
          <Datetime
            pubDatetime={koreanData.pubDatetime}
            modDatetime={koreanData.modDatetime}
            size="lg"
            className="my-2"
          />
          <article role="article" class="prose mx-auto mt-8 max-w-3xl">
            <KoreanContent />
          </article>

          <ul class="my-8">
            {koreanData.tags.map(tag => (
              <Tag tag={slugifyStr(tag)} locale="ko" />
            ))}
          </ul>
        </section>
      )
    }
    {
      EnglishContent && englishData && (
        <section
          data-post-detail-locale="en"
          data-post-title={`${englishData.title} | ${SITE.title}`}
          hidden={locale !== "en" && Boolean(KoreanContent)}
        >
          <h1 class="post-title">{englishData.title}</h1>
          <Datetime
            pubDatetime={englishData.pubDatetime}
            modDatetime={englishData.modDatetime}
            size="lg"
            className="my-2"
          />
          <article role="article" class="prose mx-auto mt-8 max-w-3xl">
            <EnglishContent />
          </article>

          <ul class="my-8">
            {englishData.tags.map(tag => (
              <Tag tag={slugifyStr(tag)} locale="en" />
            ))}
          </ul>
        </section>
      )
    }

    <PostComments />

    <div
      class="mt-12 flex flex-col-reverse items-center justify-between gap-6 sm:flex-row-reverse sm:items-end sm:gap-4"
    >
      <button
        id="back-to-top"
        class="focus-outline whitespace-nowrap py-1 hover:opacity-75"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="rotate-90">
          <path
            d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"
          ></path>
        </svg>
        <span>Back to Top</span>
      </button>

      <ShareLinks />
    </div>
  </main>
  <Footer />
</Layout>

<style>
  main {
    @apply mx-auto w-full max-w-3xl px-4 pb-12;
  }
  .post-title {
    @apply text-2xl font-semibold text-skin-accent;
  }
</style>

<script>
  /* eslint-disable */
  import { initPostEnhancements } from "@utils/postEnhancements";

  function getCurrentLocale() {
    const queryLocale = new URLSearchParams(window.location.search).get("lang");
    if (queryLocale === "en" || queryLocale === "ko") return queryLocale;

    const contextLocale = window.__BLOG_LOCALE_CONTEXT__?.getLocale?.();
    if (contextLocale === "en" || contextLocale === "ko") return contextLocale;

    return document.documentElement.dataset.locale === "en" ? "en" : "ko";
  }

  function withLocale(href: string, locale: "en" | "ko") {
    const url = new URL(href, window.location.origin);
    if (url.origin !== window.location.origin) return href;
    url.searchParams.set("lang", locale);
    const query = url.searchParams.toString();
    return query ? `${url.pathname}?${query}` : url.pathname;
  }

  function syncPostTagLinksLocale() {
    const locale = getCurrentLocale();
    const links = document.querySelectorAll('[data-tag-link][href^="/tags/"]');

    for (const link of links) {
      const href = link.getAttribute("href");
      if (!href) continue;
      link.setAttribute("href", withLocale(href, locale));
    }
  }

  function applyLocalizedPostDetail() {
    const locale = getCurrentLocale();
    const sections = Array.from(
      document.querySelectorAll<HTMLElement>("[data-post-detail-locale]")
    );
    if (sections.length === 0) return;

    const hasKoreanSection = sections.some(
      section => section.dataset.postDetailLocale === "ko"
    );
    const hasEnglishSection = sections.some(
      section => section.dataset.postDetailLocale === "en"
    );

    const effectiveLocale =
      locale === "en" && hasEnglishSection
        ? "en"
        : hasKoreanSection
          ? "ko"
          : "en";

    sections.forEach(section => {
      section.hidden = section.dataset.postDetailLocale !== effectiveLocale;
    });

    const activeSection = sections.find(
      section => section.dataset.postDetailLocale === effectiveLocale
    );
    const activeTitle = activeSection?.dataset.postTitle;
    if (activeTitle) {
      document.title = activeTitle;
    }

    const search = new URLSearchParams(window.location.search);
    if (search.get("lang") !== effectiveLocale) {
      search.set("lang", effectiveLocale);
      const query = search.toString();
      const targetUrl = query
        ? `${window.location.pathname}?${query}`
        : window.location.pathname;
      window.history.replaceState({}, "", targetUrl);
    }
  }

  let cleanup = initPostEnhancements();
  applyLocalizedPostDetail();
  syncPostTagLinksLocale();
  const handleLocaleChange = () => {
    applyLocalizedPostDetail();
    syncPostTagLinksLocale();
  };

  document.addEventListener("astro:before-swap", () => {
    cleanup?.();
    window.removeEventListener("blog:locale-change", handleLocaleChange);
  });

  document.addEventListener("astro:after-swap", () => {
    cleanup?.();
    cleanup = initPostEnhancements();
    applyLocalizedPostDetail();
    syncPostTagLinksLocale();
  });

  window.addEventListener("blog:locale-change", handleLocaleChange);
  /* eslint-enable */
</script>
